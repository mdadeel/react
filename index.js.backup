#!/usr/bin/env node

import inquirer from 'inquirer';
import chalk from 'chalk';
import ora from 'ora';
import { execSync } from 'child_process';
import fs from 'fs-extra';
import path from 'path';

// Beautiful ASCII Art Banner
const banner = `
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                                                           ‚ïë
‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó             ‚ïë
‚ïë   ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù             ‚ïë
‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë        ‚ñà‚ñà‚ïë                ‚ïë
‚ïë   ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë        ‚ñà‚ñà‚ïë                ‚ïë
‚ïë   ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïë                ‚ïë
‚ïë   ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù   ‚ïö‚ïê‚ïù                ‚ïë
‚ïë                                                           ‚ïë
‚ïë              üöÄ Setup Pro - v1.0.0                       ‚ïë
‚ïë         Create modern web apps in seconds!               ‚ïë
‚ïë                                                           ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
`;

console.clear();
console.log(chalk.magenta(banner));
console.log(chalk.bold.cyan('  üí° Navigation Tips:'));
console.log(chalk.gray('     ‚Ä¢ Use ‚Üë‚Üì arrow keys to move'));
console.log(chalk.gray('     ‚Ä¢ Press Enter to confirm'));
console.log(chalk.gray('     ‚Ä¢ Selected option will be ') + chalk.magenta.bold('highlighted') + chalk.gray(' in magenta\n'));

// Enhanced prompts with custom colors and arrow
const questions = [
  {
    type: 'input',
    name: 'projectName',
    message: chalk.bold.magenta('üì¶ Project name:'),
    default: 'my-app',
    prefix: chalk.magenta('‚ùØ'),
    validate: (input) => {
      if (/^([A-Za-z\-\_\d])+$/.test(input)) return true;
      return chalk.red('‚ùå Project name can only contain letters, numbers, dashes and underscores');
    },
    transformer: (input) => chalk.cyan(input)
  },
  {
    type: 'list',
    name: 'framework',
    message: chalk.bold.magenta('üé® Choose your framework:'),
    prefix: chalk.magenta('‚ùØ'),
    choices: [
      { 
        name: '‚öõÔ∏è  React', 
        value: 'react',
        short: 'React'
      },
      { 
        name: 'üíö Vue', 
        value: 'vue',
        short: 'Vue'
      },
      { 
        name: 'üî∫ Svelte', 
        value: 'svelte',
        short: 'Svelte'
      },
      { 
        name: 'üî∑ Preact', 
        value: 'preact',
        short: 'Preact'
      },
      { 
        name: 'üî∂ Lit', 
        value: 'lit',
        short: 'Lit'
      },
      { 
        name: '‚ö° Vanilla', 
        value: 'vanilla',
        short: 'Vanilla'
      }
    ],
    default: 'react',
    pageSize: 6,
    loop: false
  },
  {
    type: 'list',
    name: 'language',
    message: chalk.bold.magenta('üìù Select your language:'),
    prefix: chalk.magenta('‚ùØ'),
    choices: [
      { 
        name: 'üìò TypeScript', 
        value: 'typescript',
        short: 'TypeScript'
      },
      { 
        name: 'üìô JavaScript', 
        value: 'javascript',
        short: 'JavaScript'
      }
    ],
    default: 'javascript',
    loop: false
  },
  {
    type: 'confirm',
    name: 'tailwind',
    message: chalk.bold.magenta('üé® Add Tailwind CSS?') + chalk.gray(' (Utility-first CSS framework)'),
    prefix: chalk.magenta('‚ùØ'),
    default: true,
    when: (answers) => ['react', 'vue', 'svelte', 'preact'].includes(answers.framework),
    transformer: (answer) => answer ? chalk.cyan('‚úì Yes') : chalk.red('‚úó No')
  },
  {
    type: 'confirm',
    name: 'router',
    message: chalk.bold.magenta('üß≠ Include router?') + chalk.gray(' (For multi-page navigation)'),
    prefix: chalk.magenta('‚ùØ'),
    default: false,
    when: (answers) => ['react', 'vue', 'svelte'].includes(answers.framework),
    transformer: (answer) => answer ? chalk.cyan('‚úì Yes') : chalk.red('‚úó No')
  },
  {
    type: 'confirm',
    name: 'folderStructure',
    message: chalk.bold.magenta('üìÅ Create organized folder structure?') + chalk.gray(' (Recommended)'),
    prefix: chalk.magenta('‚ùØ'),
    default: true,
    transformer: (answer) => answer ? chalk.cyan('‚úì Yes') : chalk.red('‚úó No')
  }
];

// Template mapping
const getTemplate = (framework, language) => {
  const templates = {
    react: language === 'typescript' ? 'react-ts' : 'react',
    vue: language === 'typescript' ? 'vue-ts' : 'vue',
    svelte: language === 'typescript' ? 'svelte-ts' : 'svelte',
    preact: language === 'typescript' ? 'preact-ts' : 'preact',
    lit: language === 'typescript' ? 'lit-ts' : 'lit',
    vanilla: language === 'typescript' ? 'vanilla-ts' : 'vanilla'
  };
  return templates[framework];
};

// Router packages
const getRouterPackage = (framework) => {
  const routers = {
    react: 'react-router-dom',
    vue: 'vue-router',
    svelte: 'svelte-routing'
  };
  return routers[framework];
};

// File extensions
const getFileExtension = (framework, language) => {
  if (language === 'typescript') {
    return framework === 'react' || framework === 'preact' ? 'tsx' : 'ts';
  }
  return framework === 'react' || framework === 'preact' ? 'jsx' : 'js';
};

// Draw a nice box
const drawBox = (title, content) => {
  const width = 55;
  console.log(chalk.magenta('‚îå' + '‚îÄ'.repeat(width) + '‚îê'));
  console.log(chalk.magenta('‚îÇ') + chalk.bold.cyan(title.padEnd(width)) + chalk.magenta('‚îÇ'));
  console.log(chalk.magenta('‚îú' + '‚îÄ'.repeat(width) + '‚î§'));
  content.forEach(line => {
    console.log(chalk.magenta('‚îÇ') + ' ' + line.padEnd(width - 1) + chalk.magenta('‚îÇ'));
  });
  console.log(chalk.magenta('‚îî' + '‚îÄ'.repeat(width) + '‚îò'));
};

async function createProject() {
  try {
    const answers = await inquirer.prompt(questions);
    const { projectName, framework, language, tailwind, router, folderStructure } = answers;
    
    // Show framework description after selection
    const frameworkInfo = {
      react: { emoji: '‚öõÔ∏è', desc: 'The most popular library for building user interfaces' },
      vue: { emoji: 'üíö', desc: 'Progressive framework that\'s easy to learn and powerful' },
      svelte: { emoji: 'üî∫', desc: 'Truly reactive framework with no virtual DOM' },
      preact: { emoji: 'üî∑', desc: 'Fast 3KB alternative to React with the same API' },
      lit: { emoji: 'üî∂', desc: 'Simple, fast, and lightweight web components' },
      vanilla: { emoji: '‚ö°', desc: 'Pure JavaScript with no framework overhead' }
    };
    
    console.log('\n' + chalk.magenta('  ‚úì Selected: ') + frameworkInfo[framework].emoji + ' ' + chalk.bold.cyan(framework.toUpperCase()));
    console.log(chalk.gray('    ' + frameworkInfo[framework].desc) + '\n');
    
    const projectPath = path.join(process.cwd(), projectName);
    const template = getTemplate(framework, language);
    const fileExt = getFileExtension(framework, language);
    const isTypeScript = language === 'typescript';
    
    // Display beautiful configuration summary
    console.log('\n');
    drawBox('  üìã YOUR CONFIGURATION', [
      '',
      `  ${chalk.gray('Project:')}      ${chalk.cyan.bold(projectName)}`,
      `  ${chalk.gray('Framework:')}    ${chalk.cyan.bold(framework.toUpperCase())}`,
      `  ${chalk.gray('Language:')}     ${chalk.cyan.bold(isTypeScript ? 'TypeScript' : 'JavaScript')}`,
      `  ${chalk.gray('Tailwind CSS:')} ${tailwind ? chalk.magenta.bold('‚úì Yes') : chalk.red.bold('‚úó No')}`,
      `  ${chalk.gray('Router:')}       ${router ? chalk.magenta.bold('‚úì Yes') : chalk.red.bold('‚úó No')}`,
      `  ${chalk.gray('Structure:')}    ${folderStructure ? chalk.magenta.bold('‚úì Yes') : chalk.red.bold('‚úó No')}`,
      ''
    ]);
    console.log('\n');
    
    // 1. Create Vite project
    const spinner = ora({
      text: chalk.magenta(`Creating ${framework} project...`),
      color: 'magenta',
      spinner: 'dots12'
    }).start();
    
    execSync(`npm create vite@latest ${projectName} -- --template ${template}`, { stdio: 'inherit' });
    spinner.succeed(chalk.cyan(`‚úì ${framework.charAt(0).toUpperCase() + framework.slice(1)} project created!`));
    
    process.chdir(projectPath);
    
    // 2. Install dependencies
    spinner.start(chalk.magenta('Installing dependencies...'));
    execSync('npm install', { stdio: 'ignore' });
    spinner.succeed(chalk.cyan('‚úì Dependencies installed!'));
    
    // 3. Setup Tailwind CSS (Modern v4 with Vite plugin)
    if (tailwind) {
      spinner.start(chalk.magenta('Setting up Tailwind CSS...'));
      
      // Install Tailwind v4 with Vite plugin
      execSync('npm install -D tailwindcss @tailwindcss/vite', { stdio: 'ignore' });
      
      // Update vite.config file
      const viteConfigFile = isTypeScript ? 'vite.config.ts' : 'vite.config.js';
      
      if (fs.existsSync(viteConfigFile)) {
        let viteConfig = fs.readFileSync(viteConfigFile, 'utf8');
        
        // Add import at the top
        if (!viteConfig.includes('@tailwindcss/vite')) {
          // Find the import section
          const importMatch = viteConfig.match(/import\s+.*\s+from\s+['"].*['"]/);
          if (importMatch) {
            const lastImportIndex = viteConfig.lastIndexOf(importMatch[0]) + importMatch[0].length;
            viteConfig = viteConfig.slice(0, lastImportIndex) + 
                        "\nimport tailwindcss from '@tailwindcss/vite'" + 
                        viteConfig.slice(lastImportIndex);
          } else {
            // No imports found, add at the beginning
            viteConfig = "import tailwindcss from '@tailwindcss/vite'\n" + viteConfig;
          }
        }
        
        // Add plugin to plugins array
        if (!viteConfig.includes('tailwindcss()')) {
          if (viteConfig.includes('plugins: [')) {
            // Plugins array exists, add tailwindcss to it
            viteConfig = viteConfig.replace(
              /plugins:\s*\[/,
              'plugins: [\n    tailwindcss(),'
            );
          } else {
            // No plugins array, create one
            viteConfig = viteConfig.replace(
              /export default defineConfig\(\{/,
              'export default defineConfig({\n  plugins: [tailwindcss()],'
            );
          }
        }
        
        fs.writeFileSync(viteConfigFile, viteConfig);
      }
      
      // Update CSS file with modern @import
      const cssContent = `@import "tailwindcss";

/* Your custom styles below */
`;
      
      const cssFiles = ['src/index.css', 'src/style.css', 'src/app.css'];
      const cssFile = cssFiles.find(file => fs.existsSync(file)) || 'src/index.css';
      fs.writeFileSync(cssFile, cssContent);
      
      spinner.succeed(chalk.cyan('‚úì Tailwind CSS configured with Vite plugin!'));
    }
    
    // 4. Setup Router
    if (router) {
      spinner.start(chalk.magenta(`Setting up ${framework} router...`));
      
      const routerPackage = getRouterPackage(framework);
      execSync(`npm install ${routerPackage}`, { stdio: 'ignore' });
      
      spinner.succeed(chalk.cyan(`‚úì ${framework.charAt(0).toUpperCase() + framework.slice(1)} router installed!`));
    }
    
    // 5. Create folder structure
    if (folderStructure) {
      spinner.start(chalk.magenta('Creating folder structure...'));
      
      const folders = framework === 'vue' 
        ? ['components', 'views', 'composables', 'assets']
        : framework === 'svelte'
        ? ['components', 'routes', 'stores', 'assets']
        : ['components', 'pages', 'hooks', 'assets'];
      
      folders.forEach(folder => {
        const folderPath = path.join('src', folder);
        fs.ensureDirSync(folderPath);
        
        let readmeContent = `# ${folder.charAt(0).toUpperCase() + folder.slice(1)}\n\n`;
        if (folder === 'components') readmeContent += 'Put your reusable components here!';
        else if (folder === 'pages' || folder === 'views' || folder === 'routes') readmeContent += 'Put your page/route components here!';
        else if (folder === 'hooks' || folder === 'composables') readmeContent += 'Put your custom hooks/composables here!';
        else if (folder === 'stores') readmeContent += 'Put your Svelte stores here!';
        else readmeContent += 'Put your images, fonts, and other files here!';
        
        fs.writeFileSync(path.join(folderPath, 'README.md'), readmeContent);
      });
      
      spinner.succeed(chalk.cyan('‚úì Folder structure created!'));
    }
    
    // 6. Create README
    const frameworkDocs = {
      react: 'https://react.dev',
      vue: 'https://vuejs.org',
      svelte: 'https://svelte.dev',
      preact: 'https://preactjs.com',
      lit: 'https://lit.dev',
      vanilla: 'https://vitejs.dev'
    };
    
    const readmeContent = `# ${projectName}

Welcome to your new ${framework} project! üöÄ

## Tech Stack

- **Framework:** ${framework.charAt(0).toUpperCase() + framework.slice(1)}
- **Language:** ${isTypeScript ? 'TypeScript' : 'JavaScript'}
- **Build Tool:** Vite
${tailwind ? '- **Styling:** Tailwind CSS\n' : ''}${router ? `- **Router:** ${getRouterPackage(framework)}\n` : ''}
## Getting Started

\`\`\`bash
npm run dev
\`\`\`

Open http://localhost:5173 in your browser

## Available Commands

- \`npm run dev\` - Start development server
- \`npm run build\` - Build for production
- \`npm run preview\` - Preview production build

## Learn More

- [${framework.charAt(0).toUpperCase() + framework.slice(1)} Documentation](${frameworkDocs[framework]})
- [Vite Documentation](https://vitejs.dev)
${tailwind ? '- [Tailwind CSS Documentation](https://tailwindcss.com)\n' : ''}${isTypeScript ? '- [TypeScript Documentation](https://www.typescriptlang.org)\n' : ''}
Happy coding! üíª‚ú®
`;
    
    fs.writeFileSync('README.md', readmeContent);
    
    // Final success message with beautiful formatting
    const frameworkEmojis = {
      react: '‚öõÔ∏è',
      vue: 'üíö',
      svelte: 'üî∫',
      preact: 'üî∑',
      lit: 'üî∂',
      vanilla: '‚ö°'
    };
    
    console.log('\n');
    console.log(chalk.magenta('‚ïê'.repeat(60)));
    console.log(chalk.magenta.bold('  ‚ú® SUCCESS! Your project is ready to go! ‚ú®'));
    console.log(chalk.magenta('‚ïê'.repeat(60)));
    console.log('');
    console.log(chalk.cyan.bold('  üìÇ Project:'), chalk.white(projectName), frameworkEmojis[framework]);
    console.log('');
    console.log(chalk.magenta.bold('  üöÄ Next Steps:'));
    console.log('');
    console.log(chalk.white('     1.'), chalk.cyan(`cd ${projectName}`));
    console.log(chalk.white('     2.'), chalk.cyan('npm run dev'));
    console.log(chalk.white('     3.'), chalk.cyan('Open http://localhost:5173'));
    console.log('');
    
    if (tailwind) {
      console.log(chalk.cyan.bold('  üí° Tailwind Tip:'));
      console.log(chalk.gray('     Try: ') + chalk.white('<h1 className="text-blue-500 text-4xl">Hello!</h1>'));
      console.log('');
    }
    
    if (router) {
      console.log(chalk.cyan.bold('  üß≠ Router Docs:'));
      if (framework === 'react') {
        console.log(chalk.gray('     https://reactrouter.com'));
      } else if (framework === 'vue') {
        console.log(chalk.gray('     https://router.vuejs.org'));
      } else if (framework === 'svelte') {
        console.log(chalk.gray('     https://github.com/EmilTholin/svelte-routing'));
      }
      console.log('');
    }
    
    console.log(chalk.magenta('‚ïê'.repeat(60)));
    console.log(chalk.gray('  Need help? Check out README.md in your project folder!'));
    console.log(chalk.magenta('‚ïê'.repeat(60)));
    console.log('');
    
  } catch (error) {
    console.log('');
    console.log(chalk.red('‚ïê'.repeat(60)));
    console.log(chalk.red.bold('  ‚ùå ERROR'));
    console.log(chalk.red('‚ïê'.repeat(60)));
    console.log('');
    console.log(chalk.white('  Message:'), chalk.magenta(error.message));
    console.log('');
    console.log(chalk.cyan('  üí° Troubleshooting tips:'));
    console.log(chalk.white('     ‚Ä¢ Check your internet connection'));
    console.log(chalk.white('     ‚Ä¢ Make sure Node.js is installed (node --version)'));
    console.log(chalk.white('     ‚Ä¢ Try running the command again'));
    console.log('');
    console.log(chalk.red('‚ïê'.repeat(60)));
    console.log('');
    process.exit(1);
  }
}

createProject();
